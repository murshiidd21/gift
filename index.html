<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For You</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400&display=swap"
        rel="stylesheet">
    <style>
        body {
            background-color: #fcfbf7;
            background-image: url('floral-bg.png');
            /* Ensure this file exists or fallback */
            background-size: 300px;
            background-repeat: repeat;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: 'Playfair Display', serif;
            overflow: hidden;
            touch-action: none;
            /* Prevent scrolling */
        }

        #card {
            background: rgba(255, 255, 255, 0.9);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(93, 64, 55, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            backdrop-filter: blur(8px);
            max-width: 90%;
            width: 340px;
            border: 1px solid rgba(212, 163, 115, 0.3);
        }

        h1 {
            font-size: 1.8rem;
            color: #5d4037;
            margin: 0 0 30px 0;
            font-weight: 400;
            letter-spacing: 0.5px;
            text-align: center;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        #crank-container {
            position: relative;
            width: 220px;
            height: 220px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(230, 224, 212, 0.3) 0%, rgba(255, 255, 255, 0) 70%);
        }

        /* The Crank Image */
        #crank {
            width: 100%;
            height: 100%;
            background-image: url('crank.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: grab;
            filter: drop-shadow(4px 4px 8px rgba(93, 64, 55, 0.2));
            transform-origin: 50% 50%;
            will-change: transform;
            transition: transform 0.05s linear;
            mix-blend-mode: multiply;
            /* Handles white background in image */
        }

        #crank:active {
            cursor: grabbing;
            transform: scale(0.98);
            /* Press effect */
        }

        /* Progress Bar */
        #progress-container {
            width: 80%;
            height: 6px;
            background: #e6e0d4;
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #d4a373, #8d6e63);
            transition: width 0.1s linear;
        }

        #instruction {
            margin-top: 20px;
            color: #8d7b6f;
            font-family: 'Lato', sans-serif;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
            opacity: 0.8;
            transition: opacity 0.5s;
            text-transform: uppercase;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* Decorative flourishes */
        .decoration {
            position: absolute;
            font-size: 2rem;
            color: #d4a373;
            opacity: 0.2;
            pointer-events: none;
            user-select: none;
        }

        .top-left {
            top: 10px;
            left: 10px;
            transform: rotate(-45deg);
        }

        .bottom-right {
            bottom: 10px;
            right: 10px;
            transform: rotate(135deg);
        }
    </style>
</head>

<body>

    <div id="card">
        <div class="decoration top-left">❀</div>
        <div class="decoration bottom-right">❀</div>

        <h1>For You</h1>

        <div id="crank-container">
            <div id="crank"></div>
        </div>

        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>

        <p id="instruction">Wind clockwise to listen</p>
    </div>

    <audio id="audioPlayer" src="voice.mp3" preload="auto" loop></audio>

    <script>
        const crank = document.getElementById('crank');
        const progressBar = document.getElementById('progress-bar');
        const audio = document.getElementById('audioPlayer');
        const instruction = document.getElementById('instruction');

        // State
        let isDragging = false;
        let lastAngle = 0;
        let currentRotation = 0;
        let lastRotation = 0;

        // Settings
        const SENSITIVITY = 1.0;

        // Position Helper
        function getCenter(element) {
            const rect = element.getBoundingClientRect();
            return {
                x: rect.left + rect.width / 2,
                y: rect.top + rect.height / 2
            };
        }

        // Angle Helper
        function getAngle(x, y) {
            const center = getCenter(crank);
            return Math.atan2(y - center.y, x - center.x) * (180 / Math.PI);
        }

        // Mouse/Touch Down
        function startDrag(e) {
            isDragging = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            lastAngle = getAngle(clientX, clientY);

            // Prime audio on first interaction
            if (audio.paused && audio.currentTime === 0) {
                audio.volume = 0;
                audio.play().then(() => audio.pause()).catch(e => console.log(e));
            }
            crank.style.transition = 'none'; // Disable transition for instant dragged response
        }

        // Mouse/Touch Move
        function rotate(e) {
            if (!isDragging) return;
            e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const newAngle = getAngle(clientX, clientY);
            let delta = newAngle - lastAngle;

            // Fix wrap-around (e.g., crossing from 180 to -180)
            if (delta > 180) delta -= 360;
            if (delta < -180) delta += 360;

            currentRotation += delta;
            lastAngle = newAngle;

            // Visual Update happens in loop for sync, but we can do it here too for instant feedback
            // crank.style.transform = `rotate(${currentRotation}deg)`;
        }

        // Mouse/Touch Up
        function stopDrag() {
            isDragging = false;
            crank.style.transition = 'transform 0.5s ease-out'; // Momentum feel on release
        }

        // Game Loop
        let smoothedVelocity = 0;

        function loop() {
            // Calculate velocity based on frame-to-frame rotation difference
            // This is more stable than event-based velocity
            let velocity = currentRotation - lastRotation;
            lastRotation = currentRotation;

            // Apply to visual
            crank.style.transform = `rotate(${currentRotation}deg)`;

            // Audio Logic
            // We want the audio to play if there is significant positive (clockwise) velocity
            // Or just velocity in general? Let's say any winding works.
            let speed = Math.abs(velocity);

            // Smooth the velocity for audio playback to prevent jitter
            smoothedVelocity += (speed - smoothedVelocity) * 0.1;

            if (smoothedVelocity > 0.5) { // Threshold to start playing
                if (audio.paused) {
                    audio.play().catch(e => { }); // Ignore abortion errors
                }

                // Map speed to playback rate (optional, for fun physics)
                // Normal winding might be ~5-15 deg per frame
                let rate = 0.5 + (smoothedVelocity / 20);
                rate = md_clamp(rate, 0.5, 2.0); // Clamp between 0.5x and 2.0x
                audio.playbackRate = rate;

                // Volume fade in
                if (audio.volume < 1.0) audio.volume = Math.min(1.0, audio.volume + 0.05);

                instruction.style.opacity = 0;
            } else {
                // Stop/Pause logic
                // Fade out
                if (audio.volume > 0.05) {
                    audio.volume -= 0.05;
                } else {
                    audio.volume = 0;
                    audio.pause();
                }
                if (!isDragging) instruction.style.opacity = 0.8;
            }

            // Update Progress
            if (audio.duration) {
                const p = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = `${p}%`;
            }

            requestAnimationFrame(loop);
        }

        function md_clamp(val, min, max) {
            return Math.min(Math.max(val, min), max);
        }

        // Events
        crank.addEventListener('mousedown', startDrag);
        window.addEventListener('mousemove', rotate);
        window.addEventListener('mouseup', stopDrag);

        crank.addEventListener('touchstart', startDrag, { passive: false });
        window.addEventListener('touchmove', rotate, { passive: false });
        window.addEventListener('touchend', stopDrag);

        // Start
        requestAnimationFrame(loop);

    </script>
</body>

</html>
